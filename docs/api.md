# CVResume API
## Overview
The CV/Resume Evaluation API is a microservice that evaluates resume sections using an LLM scoring pipeline.

It exposes
1. Health & metadata endpoint
    - Basic uptime & latency checks
    - Gemini connectivity check
    - Metadata retrieval check
2. Debug & Lab endpoints 
    - Return example resume  payload
    - Call LLM on example payload
    - Build and inspect raw prompts
3. Section Evaluation endpoints
    - Evaluate individual resume section (Profile, Summary, Education, Experience, Activity, Skills)
    - Return criteria-level scores + aggregated section score
4. Composite Evaluation endpoint
    - Run all sections (Profile, Summary, Education, Experience, Activities, Skills) in one go
    - Return a final composite resume score plus section-level details

The Evaluation API hides internal complexity related to prompt building, LLM interaction, section weight aggregation, and scoring normalization.
<hr>

## Interactive API Docs (Swagger UI)
The service exposes Swagger UI for exploration and testing:
- Swagger UI:
    https://cvresume-service-du7yhkyaqq-as.a.run.app/docs
- OpenAPI JSON (for tools/codegen):
    https://cvresume-service-du7yhkyaqq-as.a.run.app/openapi.json (if exposed)
<hr>

## Architecture Role

```text
Client / UI / Other Backend
    |
    |  POST /evaluation/*                 (section evaluation)
    |  POST /evaluation/final-resume-score (composite)
    v
    CV/Resume Evaluation API
    ├─ Build prompts from resume_json + YAML config
    ├─ Call Gemini LLM (LlmCaller)
    ├─ Aggregate scores (SectionScoreAggregator)
    ├─ Compute final resume score (GlobalAggregator)
    └─ Return clean JSON response + response_time (seconds)
```

Upstream data source
- resume_json is typically produced by upstream systems
(e.g. CV Generation Service, E-Portfolio Service)

Downstream dependency
- Google Gemini LLM (via internal LlmCaller wrapper)

Internal configuration
- YAML-based configuration: 
    - Prompt templates 
    - Scoring weights 
    - Aggregation rules 

Configuration is not exposed via public endpoints in this version

<hr>

## Base URL (Production)
```text
    https://cvresume-service-du7yhkyaqq-as.a.run.app
```
<hr>


## Common concepts

Request Body : EvaluationPayload

Used by all /evaluation/ POST endpoints.

Example payload:

```text
{
  "resume_json": { "..." : "..." }
}
```

resume_json
- Type : object
- Required : yes (for all evaluation endpoints)
- Description :
  Structured resume payload.

  Typical fields (example only, not enforced by this service):

  - job_id : string
  - template_id : string
  - language : string ("en" / "th")
  - status : string
  - sections : object
      - key   : section names (Profile, Summary, Education, Experience, Activities, Skills)
      - value : section text & metadata
  - skills : list of skill objects

Note:
The Evaluation API does not enforce a strict schema on resume_json.
It expects a valid JSON object compatible with the internal PromptBuilder logic.


<hr>
## Common Response Shape
Most endpoints returns

```text
{
  "response": { ... },          // domain-specific payload (scores, metadata, etc.)
  "response_time": "0.12345 s"  // processing latency in seconds (string)
}
```
<hr>

## Section Score Schema (from SectionScoreAggregator)

For all **section evaluation endpoints**, the response follows the same standardized structure.

### Response Example

```json
{
  "section": "Summary",
  "total_score": 78.0,
  "scores": {
    "RoleRelevance":  { "score": 30.0, "feedback": "..." },
    "Length":         { "score": 8.0,  "feedback": "..." },
    "Grammar":        { "score": 10.0, "feedback": "..." },
    "ContentQuality": { "score": 24.0, "feedback": "..." },
    "Completeness":   { "score": 6.0,  "feedback": "..." }
  }
}
```

#### `section`
- **Type**: string  
- **Description** :  Name of the evaluated section.
    - Profile
    - Summary
    - Education
    - Experience
    - Activities
    - Skills

#### `total_score`
- **Type**: number  
- **Description**:  Aggregated score for the section after applying configured weights.

#### `scores`
- **Type**: object  
- **Description**:  Per-criteria score breakdown for the section.
    - Completeness
    - ContentQuality
    - Grammar
    - Length
    - RoleRelevance
Each criterion returns an object with the following fields:

###### `score`
- **Type**: number  
- **Description**:  
  Weighted numeric score for the criterion.

###### `feedback`
- **Type**: string  
- **Description**:  
  Short natural-language explanation generated by the LLM.

### Notes
- Not all criteria are mandatory for every section.
- The active criteria depend on section type and configuration in `weight.yaml`.
- Scores are already weighted and normalized at the section level.

<hr>


## Endpoints

### 1. Health & Metadata

#### 1.1 Health Check (FastAPI service)

**GET /**

Simple liveness endpoint. Useful for uptime monitoring.


### Request

No body.


### Response

```json
{
  "status": "ok",
  "service": "FastAPI",
  "response_time": "0.00001 s"
}
```
#### `status` : "ok" when API is reachable.
#### `service` : static identifier for this service.
#### `response_time` : local processing time (no external calls).

<hr>

### 1.2 Gemini Health Check

**GET /health/gemini**

Connectivity health check for Gemini LLM.  
Verifies that the LLM is reachable and measures round-trip (RT) latency.

### Request

No body.

### Response

```json
{
  "response": {
    "status": "connected"
  },
  "response_time": "1.23456 s"
}
```
#### `response` : Parsed JSON returned by Gemini.
#### `response_time` : Total time from sending the prompt to receiving the response.

<hr>

### 1.3 Metadata Health Check

**GET /health/metadata**

Verifies that metadata retrieval (via `get_metadata()`) is functioning correctly.

### Request

No body.

### Response

```json
{
  "message": { "...": "..." },
  "response_time": "0.01234 s"
}
```

#### `message` : Arbitrary metadata object returned from get_metadata() (e.g. config version, environment information).
#### `response_time` : Processing time for metadata retrieval.

<hr>

## 2. Debug & Lab

**Note**: These endpoints are for debugging and internal testing.  
They should be restricted or disabled in production if needed.

### 2.1 Get Example Resume Payload

**GET /evaluation/logexamplepayload**

Returns a mock resume JSON payload (from `src/mock/resume3.json`) for testing purposes.

### Request

No body.

### Response

```json
{
  "response": {
    "...": "mock resume data"
  }
}
```

<hr>


### 2.2 Call LLM with Example Payload

**GET /evaluation/callexamplepayload**

Runs an end-to-end evaluation pipeline on the mock resume payload:

- Build **Profile** prompt
- Call **Gemini**
- Aggregate section scores

### Request

No body.

### Response

```json
{
  "response": {
    "section": "Profile",
    "total_score": 85.0,
    "scores": {
      "Completeness":   { "score": 40.0, "feedback": "..." },
      "ContentQuality": { "score": 45.0, "feedback": "..." }
    }
  },
  "response_time": "2.34567 s"
}
```
(Actual numbers depend on the LLM output and configured weights.)

<hr>

### 2.3 Prompt Builder Lab

**POST /test/prompt**

Builds a prompt using the `PromptBuilder` without calling the LLM.  
Useful for debugging prompt design and criteria selection.

### Request Body

```json
{
  "section": "Summary",
  "criteria": ["Completeness", "ContentQuality", "Grammar", "Length", "RoleRelevance"],
  "targetrole": "Data scientist"
}
```

#### Request Fields
##### `section` (string, optional) Default: "Summary"
##### `criteria` (array[string], optional)
##### `targetrole` (string, optional) Default: "Data scientist"

#### Response

##### Content-Type: text/plain

##### Body: Raw prompt text that would be sent to the LLM.

### Example (truncated)
```text
[ROLE] You are the expert HR evaluator...
[OBJECTIVE] Evaluate the Summary section...
[SECTION TEXT] ...
[CRITERIA] Completeness, ContentQuality, Grammar, Length, RoleRelevance...
...
````

<hr>

## 3. Section Evaluation

All section evaluation endpoints share the following characteristics:

- **Method**: POST  
- **Body**: `EvaluationPayload`  
- **Response**: Section score schema + `response_time`

---

### 3.1 Evaluate Profile

**POST /evaluation/profile**

Evaluates the **Profile** section of the resume.

### Request

```json
{
  "resume_json": {
    "...": "resume content"
  }
}
```

<hr>

### 3.2 Evaluate Summary

**POST /evaluation/summary**

Evaluates the **Summary** section of the resume.

### Criteria Used
- Completeness
- ContentQuality
- Grammar
- Length
- RoleRelevance

### Request

```json
{
  "resume_json": { "...": "..." }
}

```json
{
  "response": {
    "section": "Summary",
    "total_score": 78.0,
    "scores": {
      "Completeness":   { "score": 16.0, "feedback": "..." },
      "ContentQuality": { "score": 24.0, "feedback": "..." },
      "Grammar":        { "score": 10.0, "feedback": "..." },
      "Length":         { "score": 8.0,  "feedback": "..." },
      "RoleRelevance":  { "score": 20.0, "feedback": "..." }
    }
  },
  "response_time": "3.12345 s"
}
```

### 3.3 Evaluate Education

**POST /evaluation/education**

Evaluates the **Education** section of the resume.

### Criteria Used
- Completeness
- RoleRelevance

### Request

```json
{
  "resume_json": { "...": "..." }
}
```
### Response
```json
{
  "response": {
    "section": "Education",
    "total_score": 82.0,
    "scores": {
      "Completeness":  { "score": 40.0, "feedback": "..." },
      "RoleRelevance": { "score": 42.0, "feedback": "..." }
    }
  },
  "response_time": "2.56789 s"
}
```

### 3.4 Evaluate Experience

**POST /evaluation/experience**

Evaluates the **Experience** section of the resume.

### Criteria Used
- Completeness
- ContentQuality
- Grammar
- Length
- RoleRelevance

### Request

```json
{
  "resume_json": { "...": "..." }
}
```

### Response
```json
{
  "response": {
    "section": "Experience",
    "total_score": 85.0,
    "scores": {
      "Completeness":   { "score": 20.0, "feedback": "..." },
      "ContentQuality": { "score": 25.0, "feedback": "..." },
      "Grammar":        { "score": 15.0, "feedback": "..." },
      "Length":         { "score": 10.0, "feedback": "..." },
      "RoleRelevance":  { "score": 15.0, "feedback": "..." }
    }
  },
  "response_time": "3.45678 s"
}
```


### 3.5 Evaluate Activities

**POST /evaluation/activities**

Evaluates the **Activities** section of the resume  
(competitions, clubs, hackathons, etc.).

### Criteria Used
- Completeness
- ContentQuality
- Grammar
- Length

### Request

```json
{
  "resume_json": { "...": "..." }
}
```

```json
{
  "response": {
    "section": "Activities",
    "total_score": 75.0,
    "scores": {
      "Completeness":   { "score": 18.0, "feedback": "..." },
      "ContentQuality": { "score": 22.0, "feedback": "..." },
      "Grammar":        { "score": 20.0, "feedback": "..." },
      "Length":         { "score": 15.0, "feedback": "..." }
    }
  },
  "response_time": "2.78901 s"
}
```


### 3.6 Evaluate Skills

**POST /evaluation/skills**

Evaluates the **Skills** section of the resume.

### Criteria Used
- Completeness
- Length
- RoleRelevance

### Request

```json
{
  "resume_json": { "...": "..." }
}
```

```json
{
  "response": {
    "section": "Skills",
    "total_score": 80.0,
    "scores": {
      "Completeness":   { "score": 30.0, "feedback": "..." },
      "Length":         { "score": 20.0, "feedback": "..." },
      "RoleRelevance":  { "score": 30.0, "feedback": "..." }
    }
  },
  "response_time": "2.11111 s"
}
```


## 4. Composite Evaluation

### 4.1 Final Resume Score

**POST /evaluation/final-resume-score**

Runs the full evaluation pipeline:

- Build prompts for the following sections:
  - Profile
  - Summary
  - Education
  - Experience
  - Activities
  - Skills
- Call **Gemini** once per section
- Aggregate per-section scores via `SectionScoreAggregator`
- Compute a final composite score via `GlobalAggregator.fn0()`

### Request

```json
{
  "resume_json": { "...": "..." }
}
```
### Response
```json
{
  "response": {
    "final_score": 86.5,
    "sections": [
      {
        "section": "Profile",
        "total_score": 90.0,
        "scores": { ... }
      },
      {
        "section": "Summary",
        "total_score": 78.0,
        "scores": { ... }
      },
      {
        "section": "Education",
        "total_score": 82.0,
        "scores": { ... }
      },
      {
        "section": "Experience",
        "total_score": 85.0,
        "scores": { ... }
      },
      {
        "section": "Activities",
        "total_score": 75.0,
        "scores": { ... }
      },
      {
        "section": "Skills",
        "total_score": 80.0,
        "scores": { ... }
      }
    ],
    "metadata": {
      "aggregation_method": "weighted_sum",
      "normalize": true,
      "final_score_max": 100,
      "round_digits": 2
    }
  },
  "response_time": "10.12345 s"
}
```

### Notes
- The exact shape of the response depends on the GlobalAggregator.fn0() implementation.
- The example above reflects the current design: per-section breakdown, final composite score, and aggregation metadata.